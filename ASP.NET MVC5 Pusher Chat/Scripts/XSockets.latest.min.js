var forceFallback=forceFallback||(window.WebSocket&&window.WebSocket.CLOSED>2?!1:!0),XSockets;Array.prototype.forEach||(Array.prototype.forEach=function(n,t){var u,i,r,f,e;if(this==null)throw new TypeError("this is null or not defined");if(r=Object(this),f=r.length>>>0,typeof n!="function")throw new TypeError(n+" is not a function");for(arguments.length>1&&(u=t),i=0;i<f;)i in r&&(e=r[i],n.call(u,e,i,r)),i++}),function(){if(!Object.defineProperty||!function(){try{return Object.defineProperty({},"x",{}),!0}catch(n){return!1}}()){var n=Object.defineProperty;Object.defineProperty=function(t,i,r){if(n)try{return n(t,i,r)}catch(u){}if(t!==Object(t))throw TypeError("Object.defineProperty called on non-object");return Object.prototype.__defineGetter__&&"get"in r&&Object.prototype.__defineGetter__.call(t,i,r.get),Object.prototype.__defineSetter__&&"set"in r&&Object.prototype.__defineSetter__.call(t,i,r.set),"value"in r&&(t[i]=r.value),t}}}();Array.prototype.filter||(Array.prototype.filter=function(n){"use strict";var i,f,r,e,t,u;if(this===void 0||this===null)throw new TypeError;if(i=Object(this),f=i.length>>>0,typeof n!="function")throw new TypeError;for(r=[],e=arguments.length>=2?arguments[1]:void 0,t=0;t<f;t++)t in i&&(u=i[t],n.call(e,u,t,i)&&r.push(u));return r});forceFallback===!0&&(window.WebSocket=function(){function n(n,t){var i=this;this.persistentId=localStorage.getItem(i._url);this.pollingId=XSockets.Utils.guid();this.http=new XSockets.HttpFallback;this.startListener=function(){i.readyState===0&&window.setTimeout(function(){i.readyState=1;i.listener(i.pollingId);i.onopen(i.persistentId)},500)};this.initialize=function(){var n=i.http.getJSON("/API/XSocketsWebApi?url="+encodeURIComponent(arguments[0])+"&controllers="+arguments[1]+"&pollingId="+i.pollingId,{},function(n){i.persistentId=n.persistentId;i.pollingId=n.pollingId;i.startListener()});return n.hasOwnProperty("error")&&n.error(function(n){i.onclose(n)}),n};this.initialize(n,t.join(","))}return n.prototype.listener=function(n){var t=this;this.http.getJSON("/API/XSocketsWebApi?pollingId="+n,{},function(n){(JSON.parse(n)||[]).forEach(function(n){t.onmessage(new t.MessageWrapper(n))});t.readyState===1&&t.listener(t.pollingId)})},n.prototype.MessageWrapper=function(n){return{type:"message",data:JSON.stringify(n)}},n.prototype.isFallback=!0,n.prototype.readyState=0,n.prototype.send=function(n){n instanceof XSockets.Message&&(n=n.toString());var t=this;return this.http.post("/API/XSocketsWebApi",{pollingId:t.pollingId,data:n},function(n){t.onerror(n)})},n.prototype.onmessage=function(){},n.prototype.onopen=function(){},n.prototype.onerror=function(){},n.prototype.onclose=function(){},n.prototype.close=function(){this.readyState=0;this.onclose({})},n}());XSockets={Version:"5.0.1",Events:{init:"1",ping:"7",pong:"8",controller:{onError:"4",onOpen:"2",onClose:"3"},storage:{set:"s1",get:"s2",clear:"s4",remove:"s3"},pubSub:{subscribe:"5",unsubscribe:"6"}},Utils:{longToByteArray:function(n){for(var r,t=[0,0,0,0,0,0,0,0],i=0;i<t.length;i++)r=n&255,t[i]=r,n=(n-r)/256;return t},stringToBuffer:function(n){for(var i=n.length,r=new Array(i),t=0;t<i;t++)r[t]=n.charCodeAt(t)&255;return new Uint8Array(r).buffer},parseUri:function(n){for(var u,f,r,e,t={},o={port:80,relative:"/"},s=["url","scheme","host","domain","port","fullPath","path","relative","controller","query"],h=n.match(/^(?:([^:\/?#]+):)?(?:\/\/(([^:\/?#]*)(?::(\d*))?))?((((?:[^?#\/]*\/)*)([^?#]*))(?:\?([^#]*))?)/),i=0;i<s.length;i++)t[s[i]]=h[i];if(t.rawQuery=t.query||"",t.query){for(u={},f=t.query.split("&"),r=0;r<f.length;r++)e=f[r].split("="),u[e[0]]=e[1];t.query=u}else t.query={};return t=XSockets.Utils.extend(o,t),t.absoluteUrl=t.scheme+"://"+t.domain+":"+t.port+o.relative+t.controller,t},randomString:function(n){for(var t="",i;t.length<n&&n>0;)i=Math.random(),t+=String.fromCharCode(Math.floor(i*26)+(i>.5?97:65));return t},getParameterByName:function(n){n=n.replace(/[\[]/,"\\[").replace(/[\]]/,"\\]");var i="[\\?&]"+n+"=([^&#]*)",r=new RegExp(i),t=r.exec(window.location.search);return t===null?"":decodeURIComponent(t[1].replace(/\+/g," "))},extend:function(n,t){var i,r;if(arguments.length>2)for(i=1;i<arguments.length;i++)this.extend(n,arguments[i]);else for(r in t)n[r]=t[r];return n},guid:function(n,t){for(t=n="";n++<36;t+=n*51&52?(n^15?8^Math.random()*(n^20?16:4):4).toString(16):"-");return t}}};XSockets.ClientInfo=function(){function n(n,t,i){arguments.length===1?this.controller=arguments[0]:(this.persistentId=t,this.connectionId=n,this.controller=i,localStorage.setItem(this.controller,JSON.stringify(this)))}return n.prototype.get=function(){return localStorage.getItem(this.controller)},n}();XSockets.BinaryMessage=function(){function n(n,t,i){if(!window.Uint8Array)throw"Unable to create a XSockets.BinaryMessage, the browser does not support Uint8Array";n&&(this.createBuffer(n.toString(),t),i&&i(this))}return n.prototype.stringToBuffer=function(n){for(var i=n.length,r=new Array(i),t=0;t<i;t++)r[t]=n.charCodeAt(t)&255;return new Uint8Array(r).buffer},n.prototype.appendBuffer=function(n,t){var i=new Uint8Array(n.byteLength+t.byteLength);return i.set(new Uint8Array(n),0),i.set(new Uint8Array(t),n.byteLength),i.buffer},n.prototype.extractMessage=function(n,t){var e=function(n){return String.fromCharCode.apply(null,new Uint16Array(n))},r=function(n){for(var t=0,i=n.byteLength-1;i>=0;i--)t=t*256+n[i];return parseInt(t)},u=new Uint8Array(n,0,8),o=r(u),f=parseInt(8+r(u)),s=new Uint8Array(n,parseInt(f),n.byteLength-f),h=new Uint8Array(n,8,o),i=(new XSockets.Message).parse(e(h),s);return i.data=typeof i.data=="object"?i.data:JSON.parse(i.data),t(i),this},n.prototype.createBuffer=function(n,t){return this.header=new Uint8Array(XSockets.Utils.longToByteArray(n.length)),this.buffer=this.appendBuffer(this.appendBuffer(this.header,this.stringToBuffer(n)),t),this},n}();XSockets.Subscriptions=function(){var n=function(n){this._subscriptions=n||[];Object.defineProperty(this._subscriptions,"find",{enumerable:!1,configurable:!0,writable:!0,value:function(n){var t;if(typeof n!="function")throw new TypeError("predicate must be a function");var i=Object(this),u=i.length>>>0,f=arguments[1],r;for(t=0;t<u;t++)if(t in i&&(r=i[t],n.call(f,r,t,i)))return r;return undefined}});Object.defineProperty(this._subscriptions,"findIndex",{enumerable:!1,configurable:!0,writable:!0,value:function(n){var t;if(typeof n!="function")throw new TypeError("predicate must be a function");var i=Object(this),u=i.length>>>0,f=arguments[1],r;for(t=0;t<u;t++)if(t in i&&(r=i[t],n.call(f,r,t,i)))return t;return-1}})};return n.prototype.get=function(n){return this._subscriptions.find(n)},n.prototype.add=function(n){return this._subscriptions.push(n),this},n.prototype.remove=function(n){var t=this._subscriptions.findIndex(function(t){return t.topic===n});return t>=0&&this._subscriptions.splice(t,1),this},n.prototype.getAll=function(){return this._subscriptions},n}();XSockets.Message=function(){function n(n,t,i){this.T=n?n.toLowerCase():undefined;this.D=t;this.C=i?i.toLowerCase():undefined;this.JSON={T:n,D:JSON.stringify(t),C:i}}return n.prototype.parse=function(n,t){var i=JSON.parse(n);return{topic:i.T,controller:i.C,data:JSON.parse(i.D),binary:t}},n.prototype.toString=function(){return JSON.stringify(this.JSON)},n}();XSockets.Communcation=function(){var n=null,t=function(t,i,r,u){var e=[],f,o=window.WebSocket.toString();f=o.indexOf("[native code]")>-1||o.indexOf("[object WebSocketConstructor]")>-1?new window.WebSocket(t,r):new window.WebSocket(t,u);f.binaryType="arraybuffer";f.onmessage=i.onmessage;f.onclose=i.onclose;f.onopen=function(n){for(var t=0;t<e.length;t++)s(e[t]);e=[];i.onopen(n)};var h=function(){return XSockets.Utils.guid()},s=function(n){if(f.readyState===0)e.push(n);else if(f.readyState===1)return f.send(n)},c=function(){n=null;f.close()},l=function(){return f.readyState},a=function(){return"WebSocket"in window&&window.WebSocket.CLOSED>2?"RFC6455":"fallback"}();return{send:s,instanceId:h(),clientType:a,readyState:l,close:c,binaryType:function(n){f.binaryType=n},getWebSocket:function(){return f}}};return{getInstance:function(i,r,u,f,e){return n===null||f?t(i,r,u,e):n}}}();XSockets.Controller=function(){var n=function(n,t,i){this.promises={};this.webSocket=t;this.instanceId=XSockets.Utils.guid();this.subscriptions=new XSockets.Subscriptions(i);this.clientInfo=new XSockets.ClientInfo(n);this.name=n.toLowerCase()};return n.prototype.close=function(){return this.webSocket.send(new XSockets.Message(XSockets.Events.controller.onClose,{},this.name)),this},n.prototype.storageGet=function(n,t){var i=XSockets.Events.storage.get+":"+n,r=new XSockets.Deferred;return this.promises[i]=r,this.webSocket.send(new XSockets.Message(XSockets.Events.storage.get,{K:n},this.name)),t&&this.promises[i].promise.then(t),this.promises[i].promise},n.prototype.addSubscriptions=function(n){this.subscriptions=new XSockets.Subscriptions(n)},n.prototype.storageRemove=function(n,t){var i=XSockets.Events.storage.remove+":"+n,r=new XSockets.Deferred;return this.promises[i]=r,this.webSocket.send(new XSockets.Message(XSockets.Events.storage.remove,{K:n},this.name)),t&&this.promises[i].promise.then(t),this.promises[i].promise},n.prototype.storageClear=function(n){var t=XSockets.Events.storage.clear+":"+XSockets.Utils.randomString(8),i=new XSockets.Deferred;return this.promises[t]=i,this.webSocket.send(new XSockets.Message(XSockets.Events.storage.clear,{},this.name)),n&&this.promises[t].promise.then(n),this.promises[t].promise},n.prototype.storageSet=function(n,t){var i=XSockets.Events.storage.set+":"+n,r=new XSockets.Deferred;return this.promises[i]=r,this.webSocket.send(new XSockets.Message(XSockets.Events.storage.set,{K:n,V:typeof t=="object"?JSON.stringify(t):t},this.name)),this.promises[i].promise},n.prototype.setProperty=function(n,t){var r="set_"+n.toLowerCase(),i;i=t instanceof Array?{value:t}:t instanceof Object?t:{value:t};this.publish(new XSockets.Message(r,i,this.name))},n.prototype.setEnum=function(n,t){var i="set_"+n.toLowerCase();this.publish(new XSockets.Message(i,t,this.name))},n.prototype.addListener=function(n,t){this.subscriptions.add(new XSockets.Subscription(n,t))},n.prototype.addListeners=function(n){var t=this,f=new XSockets.Deferred,i=new XSockets.Utils.guid,u,r;return this.promises[i]=f,n instanceof Array&&(n.forEach(function(n){t.subscriptions.add(n)}),this.webSocket.clientType==="fallback"?(u=n.map(function(n){return{T:n.topic,A:!1}}),r=this.notifyFallback(t.name,u),r.hasOwnProperty("success")&&r.success(function(){t.promises[i].resolve(n)})):t.promises[i].resolve(n)),this.promises[i].promise},n.prototype.onopen=undefined,n.prototype.onclose=undefined,n.prototype.onmessage=undefined,n.prototype.onerror=undefined,n.prototype.invokeBinary=function(n,t,i){n=n.toLowerCase();var r=new XSockets.BinaryMessage(new XSockets.Message(n,i,this.name),t);return this.publish(r),this},n.prototype.invoke=function(n,t,i){n=n.toLowerCase();var r=new XSockets.Deferred;return this.publish(n,t,i),this.promises[n]=r,this.promises[n].promise},n.prototype.publish=function(n,t,i){return n instanceof XSockets.BinaryMessage?(arguments.length===2&&t(),this.webSocket.send(arguments[0].buffer)):n instanceof XSockets.Message?(arguments.length>1&&typeof arguments[1]=="function"&&t(),this.webSocket.send(n.toString())):typeof n=="string"?(arguments.length>2&&typeof i=="function"&&i(),this.webSocket.send(new XSockets.Message(n,t,this.name).toString())):void 0},n.prototype.subscribe=function(n,t,i){return this.publish(new XSockets.Message(XSockets.Events.pubSub.subscribe,{T:n,A:i?!0:!1},this.name)),i&&this.addListener("__"+n,i),this.subscriptions.add(new XSockets.Subscription(n,t)),this},n.prototype.notifyFallback=function(n,t){return this.webSocket.send(new XSockets.Message("0x12e",t,n).toString())},n.prototype.on=function(n,t){var i=this.name,r=this.addListener(n,t,i);return this.webSocket.clientType==="fallback"?this.notifyFallback(i,[{T:n,A:!1}]):r},n.prototype.disposeListener=function(n,t){return n=n.toLowerCase(),this.subscriptions.remove(n),this.hasOwnProperty(n)&&delete this[n],t&&t(),this},n.prototype.many=function(n,t,i,r){return this.publish(new XSockets.Message(XSockets.Events.pubSub.subscribe,{T:n,A:r?!0:!1},this.name)),r&&this.addListener("__"+n,r),this.subscriptions.add(new XSockets.Subscription(n,i,t)),this},n.prototype.unsubscribe=function(n,t){return n=n.toLowerCase(),this.publish(new XSockets.Message(XSockets.Events.pubSub.unsubscribe,{T:n},t||this.name)),this.subscriptions.remove(n),this},n.prototype.one=function(n,t,i){return this.many(n,1,t,i),this},n.prototype.onopen=undefined,n.prototype.onclose=undefined,n.prototype.onmessage=undefined,n.prototype.onerror=undefined,n}();XSockets.ControllerFactory=function(){return function(){var n=function(n,t){var i={},r=[];return n.forEach(function(n){var u=t(n);i[u]||(r.push(u),i[u]=!0)}),r};this.registeredControllers=[];this.getUnique=function(){return n(this.registeredControllers,function(n){return n.name})};this.findByAlias=function(n){var t=this.registeredControllers.filter(function(t){return t.alias==n});return t[0]};this.find=function(n,t){return t=t||"",this.registeredControllers.filter(function(i){return i.alias==t&&i.name==n})};this.add=function(n){this.registeredControllers.push(n)};this.findByName=function(n){return this.registeredControllers.filter(function(t){return t.name==n})};this.get=function(n,t){this.findByName(nam).forEach(function(n,i){t(n,i)})}}}();XSockets.WebSocket=function(){function n(n,t,i){var r=this,u,f;this.instanceId=XSockets.Utils.guid();this.controllerFactory=new XSockets.ControllerFactory;this.promises={};this.uri=XSockets.Utils.parseUri(n);u=XSockets.Utils.extend(r.uri.query,i?i:{});this.settings=XSockets.Utils.extend({autoReconnect:{enabled:!1,timeOut:5e3,interval:0},parameters:u,subprotocol:"XSocketsNET",queryString:function(){var n="?";for(var t in this.parameters)n+=t+"="+encodeURIComponent(this.parameters[t])+"&";return n.slice(0,n.length-1)}},{});localStorage.getItem(this.uri.absoluteUrl)&&(this.settings.parameters.persistentId=localStorage.getItem(this.uri.absoluteUrl));this.getInstace=function(n,t,i,u){return XSockets.Communcation.getInstance(n,{onmessage:function(n){var t,i;if(typeof n.data=="string"){if(t=(new XSockets.Message).parse(n.data),t.topic==XSockets.Events.ping){r.webSocket.send("{'T':'"+XSockets.Events.pong+"','D':'"+t.data+"','C':''}");return}if(t.topic===XSockets.Events.onError){if(r.onerror)r.onerror(t.data);r.dispatchMessage(XSockets.Events.onError,t,t.controller)}else r.dispatchMessage(t.topic,t.data,t.controller)}else typeof n.data=="object"&&(i=new XSockets.BinaryMessage,i.extractMessage(n.data,function(n){r.dispatchMessage(n.topic,n,n.controller.toLowerCase())}))},onopen:function(n){if(r.onconnected)r.onconnected(n)},onclose:function(n){if(r.ondisconnected)r.ondisconnected(n);r.settings.autoReconnect.enabled&&r.settings.autoReconnect.interval===0&&(r.settings.autoReconnect.interval=window.setTimeout(function(){r.settings.autoReconnect.interval=0;r.reconnect()},r.settings.autoReconnect.timeOut))},onerror:function(n){if(r.onerror)r.onerror(n)}},t,i,u)};this.webSocket=r.getInstace(this.uri.absoluteUrl+this.settings.queryString(),this.settings.subprotocol,!1,t);this.disconnect=function(){this.webSocket.close()};f=function(n){n.forEach(function(n){n=n.toLowerCase();r.controller(n)})};this.reconnect=function(n){var t={},u=this.controllerFactory.registeredControllers.map(function(n){var i=n.name;return t[i]=n.ctrl.subscriptions._subscriptions,n}),i;r.webSocket=r.getInstace(this.uri.absoluteUrl+this.settings.queryString(),this.settings.subprotocol,!0,u);i=r.controllerFactory.registeredControllers;r.controllerFactory.registeredControllers=[];i.forEach(function(n){var i=r.controller(n.name);i.addSubscriptions(t[n.name]);i.webSocket=r.webSocket});n&&n.apply(this)};this.controller=function(n,t){var u=n.toLowerCase(),e=r.controllerFactory.find(u,t).length>0,f,i;return e?r.controllerFactory.findByName(u)[0].ctrl:(f=function(n,t,i){this.alias=i||"";this.name=n;this.ctrl=t},i=new f(u,new XSockets.Controller(u,r.webSocket),t),r.controllerFactory.add(i),r.webSocket.send(new XSockets.Message(XSockets.Events.init,{init:!0},u).toString()),i.ctrl.addListener(XSockets.Events.controller.onClose,function(n){var t=new XSockets.ClientInfo(n.CI,n.PI,n.C);if(i.ctrl.onclose)i.ctrl.onclose(t)},i.name),i.ctrl.addListener(XSockets.Events.controller.onOpen,function(n){n.hasOwnProperty("ClientInfo")&&(n=n.ClientInfo);var t=new XSockets.ClientInfo(n.CI,n.PI,n.C);if(i.ctrl.clientInfo=t,i.ctrl.onopen)i.ctrl.onopen(t);localStorage.setItem(r.uri.absoluteUrl,t.persistentId)},i.name),i.ctrl.addListener(XSockets.Events.controller.onError,function(n){if(i.ctrl.onerror)i.ctrl.onerror(n.data);if(r.onerror)r.onerror(n)},i.name),i.ctrl)};this.dispatchMessage=function(n,t,i){r.controllerFactory.findByName(i).forEach(function(i){var r=i.ctrl.subscriptions.get(function(t){return t.topic===n});if(r&&r.fire(t,function(n){i.ctrl.unsubscribe(n.topic,i.name)}),i.ctrl.promises.hasOwnProperty(n)&&i.ctrl.promises[n].resolve(t),i.ctrl.hasOwnProperty(n)&&i.ctrl[n].call(this,t),i.ctrl.onmessage)i.ctrl.onmessage(t,n,i.name)})};f(t||[this.uri.controller.toLowerCase()])}return n.prototype.onconnected=function(){},n.prototype.ondisconnected=function(){},n.prototype.onerror=function(){},n.prototype.autoReconnect=function(n){return this.settings.autoReconnect.enabled=n||!this.settings.autoReconnect.enabled,this},n.prototype.setAutoReconnect=function(n){return this.settings.autoReconnect.timeOut=n||5e3,this.settings.autoReconnect.enabled=!0,this},n}();XSockets.Promise=function(){var n=function(n){this.addCallback=n};return n.prototype.then=function(n){var t=new XSockets.Deferred;return this.addCallback(function(){var i=n.apply(null,arguments);i instanceof XSockets.Promise?i.addCallback(t.resolve):t.resolve(i)}),t.promise},n}();XSockets.Deferred=function(){function n(){var t=[],n;this.resolve=function(){if(!n){n=arguments;for(var i;i=t.shift();)i.apply(null,n)}};this.promise=new XSockets.Promise(function(i){n?i.apply(null,n):t.push(i)})}return n}();XSockets.Subscription=function(){function n(n,t,i,r){this.topic=n.toLowerCase();this.delagate=t;this.fire=function(t,i){this.delagate.call(this,t,n);this.count&&(this.count--,this.count===0&&i(this))};this.count=i;this.completed=r}return n}();XSockets.HttpFallback=function(){return function(){var n=this;this.getJSON="jQuery"in window?jQuery.getJSON:function(t,i,r){var u=new XMLHttpRequest;return u.open("GET",t+n.createQueryString(i),!0),u.setRequestHeader("Content-Type","application/json"),u.onreadystatechange=function(){u.status==200&&u.readyState===4&&r&&r(JSON.parse(this.responseText))},u.send(),u};this.post="jQuery"in window?jQuery.post:function(n,t,i){var r=new XMLHttpRequest;return r.open("POST",n,!0),r.setRequestHeader("Content-Type","application/json"),r.onreadystatechange=function(){r.status==200&&r.readyState===4&&i&&i(JSON.parse(this.responseText))},r.send(JSON.stringify(t))};this.createQueryString=function(n){var t="?";for(var i in n)t+=i+"="+encodeURIComponent(n[i])+"&";return t.slice(0,t.length-1)};this.onerror=function(){}}}();